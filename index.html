<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Icon Maker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* iOSのようなスムーズなスクロールとタップ操作 */
        body {
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .ios-btn {
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer; /* マウスカーソルを指マークに */
        }
        .ios-btn:active {
            transform: scale(0.96);
            opacity: 0.9;
        }
        /* アニメーション */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce-slow {
            animation: bounce-slow 2s infinite;
        }
        
        /* 確実に隠すためのクラス */
        .force-hidden {
            display: none !important;
        }
    </style>
    <!-- ここに動的にアイコンが挿入されます -->
    <link rel="apple-touch-icon" href="">
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">

    <!-- アプリケーションのコンテナ -->
    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col relative overflow-hidden bg-gray-50">
        
        <!-- === 画面1: エディター === -->
        <div id="editor-screen" class="p-6 flex flex-col gap-6 animate-fade-in">
            <header class="flex items-center gap-2 py-2">
                <div class="bg-gradient-to-tr from-blue-500 to-indigo-600 p-2 rounded-lg text-white shadow-md">
                    <i data-lucide="layout-grid"></i>
                </div>
                <h1 class="font-bold text-xl text-gray-900">Icon Maker</h1>
            </header>

            <!-- プレビュー -->
            <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-200 flex flex-col items-center">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Preview</p>
                <div class="flex flex-col items-center gap-2">
                    <div class="w-[60px] h-[60px] rounded-[14px] bg-gray-100 shadow-md overflow-hidden relative border border-black/5 flex items-center justify-center">
                        <img id="preview-img" src="" class="w-full h-full object-cover hidden" alt="Icon">
                        <i id="preview-placeholder" data-lucide="image" class="text-gray-300 w-8 h-8"></i>
                    </div>
                    <span id="preview-title" class="text-[11px] font-medium text-gray-600 w-20 text-center truncate">アプリ名</span>
                </div>
            </div>

            <!-- 入力フォーム -->
            <div class="space-y-4">
                <div class="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm">
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i data-lucide="image" class="text-blue-500 w-4 h-4"></i> アイコン画像
                    </label>
                    <input type="file" id="image-input" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                </div>

                <div class="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm">
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i data-lucide="link" class="text-blue-500 w-4 h-4"></i> 飛び先のURL
                    </label>
                    <input type="text" id="url-input" placeholder="例: https://youtube.com" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-gray-800 focus:outline-none focus:bg-white transition-colors">
                </div>

                <div class="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm">
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i data-lucide="smartphone" class="text-blue-500 w-4 h-4"></i> アプリ名
                    </label>
                    <input type="text" id="title-input" placeholder="ホーム画面での名前" maxlength="12" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-gray-800 focus:outline-none focus:bg-white transition-colors">
                </div>
            </div>

            <button id="create-btn" style="cursor: pointer;" class="ios-btn w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 px-6 rounded-2xl shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2 text-lg mt-2 cursor-pointer relative z-10">
                アイコン作成準備
                <i data-lucide="arrow-down" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- === 画面2: 準備完了 (ホーム追加待ち) === -->
        <!-- style="display: none;" を追加して確実に隠す -->
        <div id="ready-screen" style="display: none;" class="absolute inset-0 bg-slate-900 text-white flex-col z-20">
            <!-- 背景エフェクト -->
            <div class="absolute top-0 left-0 w-full h-full opacity-20 pointer-events-none overflow-hidden">
                <div class="absolute top-[-50px] left-[-50px] w-64 h-64 bg-purple-500 rounded-full blur-3xl"></div>
                <div class="absolute bottom-[-50px] right-[-50px] w-80 h-80 bg-blue-500 rounded-full blur-3xl"></div>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center p-6 z-10 animate-fade-in">
                <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-8 w-full max-w-sm text-center border border-white/20 shadow-2xl">
                    <div class="mb-6 flex justify-center">
                        <div class="relative">
                            <img id="ready-img" src="" class="w-24 h-24 rounded-2xl shadow-xl object-cover border-2 border-white/50">
                            <div class="absolute -bottom-2 -right-2 bg-green-500 text-white p-1 rounded-full border-2 border-slate-800">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </div>
                        </div>
                    </div>
                    
                    <h2 class="text-xl font-bold mb-4">準備完了！</h2>
                    <p class="text-sm text-gray-300 mb-6 leading-relaxed">
                        Safariの下のメニューにある<br>
                        <span class="inline-flex items-center mx-1 text-blue-300 font-bold"><i data-lucide="share" class="w-3 h-3 mr-1"></i>共有</span>から<br>
                        <span class="bg-slate-700 px-2 py-1 rounded text-white font-bold text-xs mx-1">ホーム画面に追加</span><br>
                        を選んでください。
                    </p>
                    
                    <button id="reset-btn" class="text-sm text-gray-400 hover:text-white flex items-center justify-center w-full gap-2 py-2 cursor-pointer">
                        <i data-lucide="x" class="w-4 h-4"></i> 設定をやり直す
                    </button>
                </div>
            </div>

            <div class="pb-10 pt-4 flex flex-col items-center justify-end z-20 animate-bounce-slow">
                <p class="text-sm font-bold mb-2 text-blue-300">ここをタップ！</p>
                <i data-lucide="arrow-down" class="w-8 h-8 text-blue-300"></i>
            </div>
        </div>

        <!-- === 画面3: リダイレクト中 === -->
        <!-- style="display: none;" を追加して確実に隠す -->
        <div id="redirect-screen" style="display: none;" class="min-h-screen bg-white flex flex-col items-center justify-center p-6 text-center absolute inset-0 z-30">
            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500 mb-6"></div>
            <h1 class="text-xl font-bold text-gray-800 mb-2">転送中...</h1>
            <p id="redirect-url-display" class="text-gray-500 mb-8 text-sm truncate w-full max-w-xs"></p>
            <a id="manual-link" href="#" class="bg-blue-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition-all flex items-center gap-2 cursor-pointer">
                <i data-lucide="external-link" class="w-5 h-5"></i> 今すぐ開く
            </a>
        </div>

    </div>

    <script>
        // Lucideアイコンの初期化
        try {
            lucide.createIcons();
        } catch (e) {
            console.error("Icons failed to load", e);
        }

        // 状態管理
        let imageData = null;
        let targetUrl = "";
        let appTitle = "";

        // 要素の取得
        const editorScreen = document.getElementById('editor-screen');
        const readyScreen = document.getElementById('ready-screen');
        const redirectScreen = document.getElementById('redirect-screen');
        
        const imageInput = document.getElementById('image-input');
        const urlInput = document.getElementById('url-input');
        const titleInput = document.getElementById('title-input');
        
        const previewImg = document.getElementById('preview-img');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        const previewTitle = document.getElementById('preview-title');
        const readyImg = document.getElementById('ready-img');

        // 画面切り替え用のヘルパー関数（安全に表示・非表示を切り替える）
        function showScreen(screenName) {
            // 一旦すべて隠す
            editorScreen.style.display = 'none';
            readyScreen.style.display = 'none';
            redirectScreen.style.display = 'none';

            // 指定されたものを表示
            if (screenName === 'editor') {
                editorScreen.style.display = 'flex';
            } else if (screenName === 'ready') {
                readyScreen.style.display = 'flex';
            } else if (screenName === 'redirect') {
                redirectScreen.style.display = 'flex';
            }
        }

        // URLパラメータの解析（リダイレクトモードかどうか）
        const params = new URLSearchParams(window.location.search);
        const paramUrl = params.get('url');
        const paramTitle = params.get('title');

        if (paramUrl) {
            // リダイレクトモード
            showScreen('redirect');
            
            if (paramTitle) document.title = paramTitle;
            
            document.getElementById('redirect-url-display').textContent = paramUrl;
            document.getElementById('manual-link').href = paramUrl;

            // 自動リダイレクト
            setTimeout(() => {
                window.location.href = paramUrl;
            }, 500);
        } else {
            // 通常モード（エディターを表示）
            showScreen('editor');
        }

        // 画像選択時の処理
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    imageData = reader.result;
                    previewImg.src = imageData;
                    previewImg.classList.remove('hidden');
                    previewPlaceholder.classList.add('hidden');
                    readyImg.src = imageData;
                    
                    // すぐにapple-touch-iconを更新しておく（重要）
                    updateFavicon(imageData);
                };
                reader.readAsDataURL(file);
            }
        });

        // タイトル入力時の処理
        titleInput.addEventListener('input', (e) => {
            appTitle = e.target.value;
            previewTitle.textContent = appTitle || 'アプリ名';
        });

        // 作成ボタン
        document.getElementById('create-btn').addEventListener('click', () => {
            targetUrl = urlInput.value;
            appTitle = titleInput.value;

            if (!targetUrl) {
                alert('URLを入力してください');
                return;
            }
            if (!imageData) {
                alert('アイコン画像を選択してください');
                return;
            }

            // URLの整形
            if (!targetUrl.startsWith('http')) {
                targetUrl = 'https://' + targetUrl;
            }

            // 画面切り替え
            showScreen('ready');
            
            // 重要: URLパラメータを書き換える
            // これにより、ホーム画面に追加されたときのURLが確定する
            const newUrl = `${window.location.pathname}?url=${encodeURIComponent(targetUrl)}&title=${encodeURIComponent(appTitle)}`;
            window.history.replaceState(null, '', newUrl);

            // タイトル変更
            document.title = appTitle;

            // 念のためアイコンを再適用
            updateFavicon(imageData);
        });

        // リセットボタン
        document.getElementById('reset-btn').addEventListener('click', () => {
            showScreen('editor');
            
            // URLを元に戻す
            window.history.replaceState(null, '', window.location.pathname);
            document.title = "Icon Maker";
        });

        // ファビコン/WebClipアイコンを強制更新する関数
        function updateFavicon(dataUrl) {
            // 既存のアイコンタグをすべて削除
            const links = document.querySelectorAll("link[rel*='icon']");
            links.forEach(link => link.remove());

            // 新しいタグを作成
            const link = document.createElement('link');
            link.type = 'image/png';
            link.rel = 'apple-touch-icon';
            link.href = dataUrl;
            
            // headに追加
            document.getElementsByTagName('head')[0].appendChild(link);
        }
    </script>
</body>
</html>
