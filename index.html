import React, { useState, useEffect } from 'react';
import { Plus, Trash2, Check, X, Plane, Tent, Briefcase, Settings, List, Play, ChevronRight, Save, RotateCcw, Home, Edit3, Sparkles, MessageCircle, ArrowLeft, Loader2, Smile, RefreshCw, Filter, Eye, CheckCircle, HelpCircle } from 'lucide-react';

// --- Gemini API Config ---
// APIã‚­ãƒ¼ã¯å®Ÿè¡Œç’°å¢ƒã«ã‚ˆã£ã¦æ³¨å…¥ã•ã‚Œã¾ã™
const apiKey = ""; 

// --- ã‹ã‚ã„ã„ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: ãƒ¬ãƒˆãƒ­ãƒ»ãƒˆãƒ©ãƒ³ã‚¯ãƒ»ãƒ­ãƒœãƒƒãƒˆ ---
const TrunkRobot = ({ size = 80, className = "" }) => (
  <svg width={size} height={size} viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" className={`${className} drop-shadow-lg`}>
    {/* ã‚¢ãƒ³ãƒ†ãƒŠ */}
    <line x1="50" y1="15" x2="50" y2="5" stroke="#854d0e" strokeWidth="4" strokeLinecap="round"/>
    <circle cx="50" cy="5" r="4" fill="#ef4444"/>
    
    {/* æŒã¡æ‰‹ (é©ã£ã½ã„èŒ¶è‰²) */}
    <path d="M35 25V20C35 15 40 15 42 15H58C60 15 65 15 65 20V25" stroke="#854d0e" strokeWidth="6" strokeLinecap="round" strokeLinejoin="round"/>
    
    {/* è¶³ï¼ˆã‚¿ã‚¤ãƒ¤ãƒ»æ¿ƒã„èŒ¶è‰²ï¼‰ */}
    <circle cx="30" cy="85" r="6" fill="#451a03"/>
    <circle cx="70" cy="85" r="6" fill="#451a03"/>
    
    {/* æœ¬ä½“ (ãƒ™ãƒ¼ã‚¸ãƒ¥/ã‚ªãƒ•ãƒ›ãƒ¯ã‚¤ãƒˆ) */}
    <rect x="15" y="25" width="70" height="55" rx="12" fill="#fef3c7" stroke="#854d0e" strokeWidth="4"/>
    
    {/* ãƒ™ãƒ«ãƒˆè£…é£¾ (ç¸¦ãƒ©ã‚¤ãƒ³) */}
    <rect x="28" y="25" width="8" height="55" fill="#d97706" opacity="0.8"/>
    <rect x="64" y="25" width="8" height="55" fill="#d97706" opacity="0.8"/>
    
    {/* ã‚³ãƒ¼ãƒŠãƒ¼ã‚¬ãƒ¼ãƒ‰ (é©ãƒ‘ãƒƒãƒé¢¨ãƒ»æ˜ã‚‹ã„èŒ¶è‰²) */}
    <path d="M15 37V30C15 27 17 25 20 25H27" stroke="#b45309" strokeWidth="4" strokeLinecap="round"/>
    <path d="M85 37V30C85 27 83 25 80 25H73" stroke="#b45309" strokeWidth="4" strokeLinecap="round"/>
    <path d="M15 68V75C15 78 17 80 20 80H27" stroke="#b45309" strokeWidth="4" strokeLinecap="round"/>
    <path d="M85 68V75C85 78 83 80 80 80H73" stroke="#b45309" strokeWidth="4" strokeLinecap="round"/>

    {/* é¡”ã‚¨ãƒªã‚¢ (ç™½) */}
    <rect x="25" y="35" width="50" height="25" rx="8" fill="white" stroke="#854d0e" strokeWidth="2"/>
    
    {/* ç›® (ã“ã’èŒ¶) */}
    <circle cx="40" cy="45" r="3" fill="#451a03"/>
    <circle cx="60" cy="45" r="3" fill="#451a03"/>
    
    {/* ã»ã£ãº (ã‚µãƒ¼ãƒ¢ãƒ³ãƒ”ãƒ³ã‚¯) */}
    <circle cx="32" cy="50" r="3" fill="#fb7185" opacity="0.6"/>
    <circle cx="68" cy="50" r="3" fill="#fb7185" opacity="0.6"/>
    
    {/* å£ */}
    <path d="M45 50Q50 55 55 50" stroke="#451a03" strokeWidth="2" strokeLinecap="round"/>
    
    {/* ã‚¹ãƒ†ãƒƒã‚«ãƒ¼è£…é£¾ (ãƒ¬ãƒˆãƒ­ãƒ–ãƒ«ãƒ¼) */}
    <circle cx="78" cy="65" r="5" fill="#38bdf8" transform="rotate(-15 75 68)" stroke="white" strokeWidth="1"/>
  </svg>
);

// --- åˆæœŸãƒ‡ãƒ¼ã‚¿ ---
const INITIAL_SETS = [
  {
    id: 'basic',
    name: 'åŸºæœ¬ã‚»ãƒƒãƒˆ',
    question: 'ã„ã¤ã‚‚ã®å¿…éœ€å“ï¼ˆãŠè²¡å¸ƒã‚„ã‚¹ãƒãƒ›ï¼‰ã¯å…¥ã‚Œã‚‹ï¼Ÿ',
    items: ['ãŠè²¡å¸ƒ', 'ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³', 'ãƒ¢ãƒã‚¤ãƒ«ãƒãƒƒãƒ†ãƒªãƒ¼', 'å®¶ã®éµ', 'ãƒãƒ³ã‚«ãƒãƒ»ãƒ†ã‚£ãƒƒã‚·ãƒ¥', 'å¸¸å‚™è–¬', 'é›¨å…· (é›¨ã®æ™‚)'],
    icon: 'Briefcase'
  },
  {
    id: 'plane',
    name: 'é£›è¡Œæ©Ÿã‚»ãƒƒãƒˆ',
    question: 'ä»Šå›ã¯é£›è¡Œæ©Ÿã«ä¹—ã£ã¦ãƒ“ãƒ¥ãƒ¼ãƒ³ï¼Ÿâœˆï¸',
    items: ['Eãƒã‚±ãƒƒãƒˆæ§ãˆ', 'è€³æ “/ãƒã‚¤ã‚ºã‚­ãƒ£ãƒ³ã‚»ãƒªãƒ³ã‚°ã‚¤ãƒ¤ãƒ›ãƒ³', 'ç¾½ç¹”ã‚‹ã‚‚ã®', 'ãƒã‚¹ã‚¯', 'æ‰‹å…ƒç”¨ãƒãƒƒã‚°', 'å……é›»ç”¨ã‚±ãƒ¼ãƒ–ãƒ«(USB)'],
    icon: 'Plane'
  },
  {
    id: 'hotel',
    name: 'ãŠæ³Šã¾ã‚Šã‚»ãƒƒãƒˆ',
    question: 'ãƒ›ãƒ†ãƒ«ã‚„æ—…é¤¨ã«ãŠæ³Šã¾ã‚Šã™ã‚‹ï¼ŸğŸ¨',
    items: ['ç€æ›¿ãˆ', 'ä¸‹ç€', 'åŒ–ç²§æ°´ãƒ»ä¹³æ¶²', 'ãƒ‘ã‚¸ãƒ£ãƒï¼ˆå¿…è¦ãªå ´åˆï¼‰', 'ã‚³ãƒ³ã‚¿ã‚¯ãƒˆãƒ¬ãƒ³ã‚ºç”¨å“', 'æ­¯ãƒ–ãƒ©ã‚·', 'ãƒ˜ã‚¢ãƒ–ãƒ©ã‚·', 'ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼ / ã‚¢ã‚¤ãƒ­ãƒ³', 'ãƒ¡ã‚¬ãƒ', 'é´ä¸‹'],
    icon: 'Home'
  },
  {
    id: 'outdoor',
    name: 'ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢',
    question: 'å¤–ã§æ€ã„ã£ãã‚ŠéŠã¶äºˆå®šã‚ã‚‹ï¼Ÿâ›ºï¸',
    items: ['æ—¥ç„¼ã‘æ­¢ã‚', 'å¸½å­', 'ã‚µãƒ³ã‚°ãƒ©ã‚¹', 'è™«é™¤ã‘ã‚¹ãƒ—ãƒ¬ãƒ¼', 'ãƒ¬ã‚¤ãƒ³ã‚³ãƒ¼ãƒˆ', 'ã‚¿ã‚ªãƒ«'],
    icon: 'Tent'
  }
];

export default function App() {
  // --- State ---
  const [packingSets, setPackingSets] = useState(() => {
    try {
      const saved = localStorage.getItem('packingSets');
      return saved ? JSON.parse(saved) : INITIAL_SETS;
    } catch (e) {
      return INITIAL_SETS;
    }
  });

  const [currentList, setCurrentList] = useState(() => {
    try {
      const saved = localStorage.getItem('currentList');
      return saved ? JSON.parse(saved) : [];
    } catch (e) {
      return [];
    }
  });

  const [view, setView] = useState('home');
  const [diagnosisStep, setDiagnosisStep] = useState(0);
  const [tempList, setTempList] = useState([]);
  const [editingSet, setEditingSet] = useState(null);
  const [newItemText, setNewItemText] = useState('');
  const [showUncheckedOnly, setShowUncheckedOnly] = useState(false); // æœªãƒã‚§ãƒƒã‚¯ã®ã¿è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰

  // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨State
  const [confirmModal, setConfirmModal] = useState({ isOpen: false, type: null }); // type: 'restart' | 'finish' | 'clear'

  // AI Wizard State
  const [wizardStep, setWizardStep] = useState('input');
  const [wizardSituation, setWizardSituation] = useState('');
  const [wizardSuggestions, setWizardSuggestions] = useState([]); // { name: string, desc: string, selected: boolean }
  const [wizardSetName, setWizardSetName] = useState('');
  const [wizardQuestion, setWizardQuestion] = useState('');

  // --- Effects ---
  useEffect(() => {
    localStorage.setItem('packingSets', JSON.stringify(packingSets));
  }, [packingSets]);

  useEffect(() => {
    localStorage.setItem('currentList', JSON.stringify(currentList));
  }, [currentList]);

  // --- Effects (PWA/Mobile settings) ---
  // ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã¯å‰Šé™¤ã—ã€åŸºæœ¬çš„ãªãƒ¡ã‚¿ã‚¿ã‚°ã®ã¿æ®‹ã—ã¾ã—ãŸ
  useEffect(() => {
    const metaTags = [
      { name: 'apple-mobile-web-app-capable', content: 'yes' },
      { name: 'apple-mobile-web-app-status-bar-style', content: 'black-translucent' },
      { name: 'apple-mobile-web-app-title', content: 'ãƒã‚§ãƒƒã‚«ãƒ¼å›' },
      { name: 'viewport', content: 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover' } 
    ];
    metaTags.forEach(tagInfo => {
      let meta = document.querySelector(`meta[name="${tagInfo.name}"]`);
      if (!meta) {
        meta = document.createElement('meta');
        meta.name = tagInfo.name;
        document.head.appendChild(meta);
      }
      meta.content = tagInfo.content;
    });
  }, []);

  // --- Logic: Gemini API ---
  const generateSuggestions = async () => {
    if (!wizardSituation.trim()) return;
    setWizardStep('generating');
    
    // Fallback items
    const fallbackItems = [
      { name: 'ç€æ›¿ãˆ', desc: 'æ—¥æ•°åˆ†ï¼‹äºˆå‚™ãŒã‚ã‚‹ã¨å®‰å¿ƒï¼' },
      { name: 'ã‚¿ã‚ªãƒ«', desc: 'æ±—ã‚’æ‹­ã„ãŸã‚Šã€æ•ã«ã—ãŸã‚Šä¸‡èƒ½' },
      { name: 'ãƒ“ãƒ‹ãƒ¼ãƒ«è¢‹', desc: 'æ±šã‚Œç‰©ã‚„ã‚´ãƒŸã‚’å…¥ã‚Œã‚‹ã®ã«å¿…é ˆ' },
      { name: 'å……é›»å™¨', desc: 'ã‚¹ãƒãƒ›ã®å……é›»å¿˜ã‚Œãšã«' },
      { name: 'å¸¸å‚™è–¬', desc: 'æ€¥ãªä½“èª¿ä¸è‰¯ã«å‚™ãˆã¦' },
      { name: 'æ´—é¢ç”¨å…·', desc: 'ã„ã¤ã‚‚ã®ã‚»ãƒƒãƒˆã§ãƒªãƒ©ãƒƒã‚¯ã‚¹' }
    ];

    try {
      const prompt = `
        æ—…è¡Œã®ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³: ã€Œ${wizardSituation}ã€
        
        ã“ã®ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã«å¿…è¦ãªæŒã¡ç‰©ã‚’15å€‹ã€œ20å€‹ç¨‹åº¦ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ï¼
        è¦ªã—ã¿ã‚„ã™ã„è¡¨ç¾ã‚’ä½¿ã£ã¦ã­ã€‚
        
        ã€é‡è¦ãªãŠé¡˜ã„ã€‘
        1. 1ã¤ã®é …ç›®ã«ã¯ã€Œ1ã¤ã®ã‚¢ã‚¤ãƒ†ãƒ ã€ã ã‘ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚ã€Œå¸½å­ã¨æ—¥ç„¼ã‘æ­¢ã‚ã€ã®ã‚ˆã†ã«ã€Œã¨ã€ã€Œã‚„ã€ã§ç¹‹ã„ã§ã‚»ãƒƒãƒˆã«ã—ãªã„ã§ãã ã•ã„ã€‚
        2. ã€Œãƒ¬ã‚¤ãƒ³ã‚³ãƒ¼ãƒˆ/æŠ˜ã‚ŠãŸãŸã¿å‚˜ã€ã€Œã‚·ãƒ£ãƒ³ãƒ—ãƒ¼ãƒ»ãƒªãƒ³ã‚¹ã€ã®ã‚ˆã†ã«ã€ã‚¹ãƒ©ãƒƒã‚·ãƒ¥(/)ã‚„ä¸­é»’(ãƒ»)ã§é¸æŠå¼ã«ã›ãšã€ãã‚Œãã‚Œåˆ¥ã®é …ç›®ã¨ã—ã¦ææ¡ˆã—ã¦ãã ã•ã„ã€‚
        3. é‡è¤‡ã¯æ°—ã«ã›ãšã€å¿…è¦ãªã‚‚ã®ã¯å…¨ã¦å€‹åˆ¥ã«ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚
        
        å„ã‚¢ã‚¤ãƒ†ãƒ ã«ã¤ã„ã¦ã€ã€Œã‚¢ã‚¤ãƒ†ãƒ å(name)ã€ã¨ã€ŒçŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ç†ç”±(desc)ã€ã‚’ã‚»ãƒƒãƒˆã«ã—ã¦ãã ã•ã„ã€‚
        
        å‡ºåŠ›ã¯ä»¥ä¸‹ã®å½¢å¼ã®JSONé…åˆ—ã®ã¿ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚Markdownã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯ä¸è¦ã§ã™ã€‚
        [
          {"name": "ã‚¢ã‚¤ãƒ†ãƒ å", "desc": "ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆ"},
          {"name": "ã‚¢ã‚¤ãƒ†ãƒ å", "desc": "ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆ"}
        ]
      `;

      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }]
          })
        }
      );

      if (!response.ok) throw new Error('API Error');

      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      
      const jsonMatch = text.match(/\[[\s\S]*\]/);
      let items = [];
      if (jsonMatch) {
        items = JSON.parse(jsonMatch[0]);
      } else {
        items = text.split('\n').filter(line => line.includes('- ')).map(line => ({ 
          name: line.replace('- ', '').trim(), 
          desc: 'ãŠã™ã™ã‚ã‚¢ã‚¤ãƒ†ãƒ ' 
        }));
      }

      setWizardSuggestions(items.map(item => ({ name: item.name, desc: item.desc, selected: true })));
      setWizardSetName(wizardSituation.length > 10 ? wizardSituation.substring(0, 10) + '...' : wizardSituation);
      setWizardQuestion(`${wizardSituation}ã«è¡Œãäºˆå®šã‚ã‚‹ï¼Ÿ`);
      setWizardStep('selection');

    } catch (error) {
      console.error('Gemini Error:', error);
      setWizardSuggestions(fallbackItems.map(item => ({ name: item.name, desc: item.desc, selected: true })));
      setWizardSetName(wizardSituation);
      setWizardQuestion(`${wizardSituation}ã«è¡Œãï¼Ÿ`);
      setWizardStep('selection');
    }
  };

  // --- Actions ---
  const startDiagnosis = () => {
    setDiagnosisStep(0);
    setTempList([]);
    setView('diagnose');
  };

  const handleConfirmAction = () => {
    if (confirmModal.type === 'restart') {
      startDiagnosis();
    } else if (confirmModal.type === 'finish') {
      setCurrentList([]);
      setView('home');
    } else if (confirmModal.type === 'clear') {
        setCurrentList([]);
        setView('home');
    }
    setConfirmModal({ isOpen: false, type: null });
  };

  const answerDiagnosis = (yes) => {
    const currentSet = packingSets[diagnosisStep];
    let nextTempList = [...tempList];

    if (yes) {
      currentSet.items.forEach(newItemText => {
         nextTempList = nextTempList.filter(existingItem => existingItem.text !== newItemText);
         nextTempList.push({
            id: `${currentSet.id}-${newItemText}`,
            text: newItemText,
            category: currentSet.name,
            checked: false
         });
      });
    }
    setTempList(nextTempList);

    if (diagnosisStep < packingSets.length - 1) {
      setDiagnosisStep(prev => prev + 1);
    } else {
      setCurrentList(nextTempList);
      setShowUncheckedOnly(false); // ãƒªã‚¹ãƒˆä½œæˆæ™‚ã¯å…¨è¡¨ç¤ºã«æˆ»ã™
      setView('checklist');
    }
  };

  const toggleCheck = (itemId) => {
    setCurrentList(prev => prev.map(item => 
      item.id === itemId ? { ...item, checked: !item.checked } : item
    ));
  };

  const saveSet = (set) => {
    if (packingSets.find(s => s.id === set.id)) {
      setPackingSets(prev => prev.map(s => s.id === set.id ? set : s));
    } else {
      setPackingSets(prev => [...prev, set]);
    }
    setEditingSet(null);
  };

  const saveWizardSet = () => {
    const newSet = {
      id: Date.now().toString(),
      name: wizardSetName,
      question: wizardQuestion,
      items: wizardSuggestions.filter(i => i.selected).map(i => i.name),
      icon: 'Briefcase'
    };
    setPackingSets(prev => [...prev, newSet]);
    setView('manage');
  };

  const deleteSet = (id) => {
    if (window.confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¦ã„ã„ï¼Ÿ')) {
      setPackingSets(prev => prev.filter(s => s.id !== id));
    }
  };

  const addNewItemToEditingSet = () => {
    if (!newItemText.trim()) return;
    setEditingSet(prev => ({ ...prev, items: [...prev.items, newItemText] }));
    setNewItemText('');
  };

  const removeItemFromEditingSet = (index) => {
    setEditingSet(prev => ({ ...prev, items: prev.items.filter((_, i) => i !== index) }));
  };

  // --- Render Components ---

  const renderModal = () => {
    if (!confirmModal.isOpen) return null;

    let title = "";
    let message = "";
    let confirmText = "";
    let confirmColor = "";

    if (confirmModal.type === 'restart') {
      title = "è¨ºæ–­ã‚’ã‚„ã‚Šç›´ã™ï¼Ÿ";
      message = "ç¾åœ¨ã®ãƒªã‚¹ãƒˆã¯æ¶ˆãˆã¦ã—ã¾ã„ã¾ã™ã€‚\næœ€åˆã‹ã‚‰ä½œã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ";
      confirmText = "ã‚„ã‚Šç›´ã™";
      confirmColor = "bg-sky-500 hover:bg-sky-600";
    } else if (confirmModal.type === 'finish') {
      title = "ãƒ‘ãƒƒã‚­ãƒ³ã‚°å®Œäº†ï¼";
      message = "æº–å‚™ãŠã¤ã‹ã‚Œã•ã¾ï¼\nãƒªã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¦ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ";
      confirmText = "å®Œäº†ã—ã¦çµ‚äº†";
      confirmColor = "bg-indigo-500 hover:bg-indigo-600";
    } else if (confirmModal.type === 'clear') {
        title = "ãƒªã‚¹ãƒˆã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ";
        message = "ä½œæ¥­ä¸­ã®ãƒªã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¦ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";
        confirmText = "å‰Šé™¤ã™ã‚‹";
        confirmColor = "bg-red-500 hover:bg-red-600";
    }

    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
        <div className="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl transform scale-100 transition-all">
          <h3 className="text-xl font-bold text-gray-800 mb-2 text-center">{title}</h3>
          <p className="text-gray-500 text-center mb-6 whitespace-pre-wrap leading-relaxed">{message}</p>
          <div className="flex space-x-3">
            <button 
              onClick={() => setConfirmModal({ isOpen: false, type: null })}
              className="flex-1 py-3 rounded-xl border-2 border-gray-200 text-gray-500 font-bold hover:bg-gray-50 transition-colors"
            >
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button 
              onClick={handleConfirmAction}
              className={`flex-1 py-3 rounded-xl text-white font-bold shadow-lg transition-colors ${confirmColor}`}
            >
              {confirmText}
            </button>
          </div>
        </div>
      </div>
    );
  };

  // 6. ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ç”»é¢
  const renderHowTo = () => (
    <div className="max-w-md mx-auto animate-fade-in flex flex-col min-h-[80vh] px-2">
      <div className="flex items-center mb-6 pt-2">
        <button 
          onClick={() => setView('home')} 
          className="p-3 -ml-2 text-gray-400 hover:text-sky-500 rounded-full hover:bg-sky-50 transition-colors"
        >
          <ArrowLeft size={24} />
        </button>
        <h2 className="text-xl font-bold ml-1 text-gray-800">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ ğŸ“–</h2>
      </div>

      <div className="space-y-8 flex-1 pb-32">
        
        {/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: åŸºæœ¬ã®ä½¿ã„æ–¹ */}
        <div className="space-y-4">
          <h3 className="font-bold text-sky-600 text-lg border-b-2 border-sky-100 pb-2 mb-2 flex items-center">
            ğŸ›« åŸºæœ¬ã®ä½¿ã„æ–¹ <span className="text-sm font-normal text-gray-400 ml-2">ï¼ˆæ—…è¡ŒãŒæ±ºã¾ã£ãŸã‚‰ï¼‰</span>
          </h3>
          
          <div className="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100 flex items-start space-x-4">
            <div className="bg-sky-100 p-3 rounded-2xl text-sky-500 flex-shrink-0">
              <Play size={24} fill="currentColor" />
            </div>
            <div>
              <h4 className="font-bold text-gray-700 mb-1">1. è¨ºæ–­ã‚¹ã‚¿ãƒ¼ãƒˆ</h4>
              <p className="text-sm text-gray-500 leading-relaxed">
                ã¾ãšã¯ã“ã“ã‹ã‚‰ï¼ã€Œé£›è¡Œæ©Ÿã«ä¹—ã‚‹ï¼Ÿã€ã€Œãƒ›ãƒ†ãƒ«ã«æ³Šã¾ã‚‹ï¼Ÿã€ãªã©ã®è³ªå•ã«ç­”ãˆã¦ã„ãã¾ã™ã€‚
              </p>
            </div>
          </div>

          <div className="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100 flex items-start space-x-4">
            <div className="bg-emerald-100 p-3 rounded-2xl text-emerald-500 flex-shrink-0">
              <CheckCircle size={24} />
            </div>
            <div>
              <h4 className="font-bold text-gray-700 mb-1">2. ãƒªã‚¹ãƒˆä½œæˆï¼†ãƒã‚§ãƒƒã‚¯</h4>
              <p className="text-sm text-gray-500 leading-relaxed">
                å›ç­”ã«åˆã‚ã›ã¦ã€ä»Šã®ã‚ãªãŸã«å¿…è¦ãªãƒªã‚¹ãƒˆãŒå®Œæˆï¼è·é€ ã‚Šã—ãªãŒã‚‰ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
              </p>
            </div>
          </div>
        </div>

        {/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: å¿œç”¨ï¼ˆã‚»ãƒƒãƒˆä½œæˆï¼‰ */}
        <div className="space-y-4">
          <h3 className="font-bold text-indigo-600 text-lg border-b-2 border-indigo-100 pb-2 mb-2 flex items-center">
            âœ¨ ã‚‚ã£ã¨ä¾¿åˆ©ã« <span className="text-sm font-normal text-gray-400 ml-2">ï¼ˆã‚»ãƒƒãƒˆã‚’å¢—ã‚„ã™ï¼‰</span>
          </h3>

          <div className="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100 flex items-start space-x-4">
            <div className="bg-indigo-100 p-3 rounded-2xl text-indigo-500 flex-shrink-0">
              <Sparkles size={24} fill="currentColor" />
            </div>
            <div>
              <h4 className="font-bold text-gray-700 mb-1">å°‚ç”¨ã‚»ãƒƒãƒˆã‚’ä½œã‚‹</h4>
              <p className="text-sm text-gray-500 leading-relaxed">
                ã€ŒåŸºæœ¬ã‚»ãƒƒãƒˆã€ä»¥å¤–ã«ã‚‚ã€ã€Œãƒ©ã‚¤ãƒ–å‚æˆ¦ã€ã‚„ã€Œå†¬ã®åŒ—æµ·é“ã€ãªã©ã€ç‰¹åˆ¥ãªäºˆå®šç”¨ã®ã‚»ãƒƒãƒˆã‚’ä½œã‚Œã¾ã™ã€‚<br/>
                <span className="text-indigo-500 text-xs font-bold block mt-2">ğŸ’¡ ä½œã£ãŸã‚»ãƒƒãƒˆã¯æ¬¡å›ã®è¨ºæ–­ã‹ã‚‰è³ªå•ã«ç™»å ´ã—ã¦ã€é¸ã¹ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼</span>
              </p>
            </div>
          </div>
        </div>

      </div>
      
      <button 
        onClick={() => setView('home')}
        className="fixed bottom-8 left-6 right-6 max-w-md mx-auto bg-sky-500 text-white py-4 rounded-3xl font-bold shadow-xl shadow-sky-200 hover:bg-sky-600 active:scale-95 transition-all z-20"
      >
        ã‚ã‹ã£ãŸï¼
      </button>
    </div>
  );

  const renderHome = () => (
    <div className="flex flex-col items-center justify-center min-h-[70vh] text-center space-y-4 animate-fade-in select-none p-4 pb-12">
      {/* ãƒ­ã‚´ã‚¨ãƒªã‚¢ */}
      <div className="relative mb-2">
        <div className="absolute top-0 left-0 w-full h-full bg-yellow-200 rounded-full blur-3xl opacity-50 animate-pulse"></div>
        <TrunkRobot className="relative z-10 animate-bounce-slow" size={100} />
      </div>

      <div className="space-y-1 mb-4">
        <h1 className="text-2xl font-bold text-sky-600 tracking-wider">æ—…ã®è·ç‰©ãƒã‚§ãƒƒã‚«ãƒ¼å›</h1>
        <p className="text-sky-400 text-xs font-medium">å¿˜ã‚Œç‰©ã‚¼ãƒ­ã§ã€æœ€é«˜ã®æ—…ã‚’ï¼âœ¨</p>
      </div>

      {/* ãƒ¡ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ */}
      <div className="w-full max-w-sm space-y-6">
        
        {/* ACTION 1: æ—…è¡Œã«è¡Œãæ™‚ (ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆä½œæˆ) */}
        <div className="text-left animate-fade-in" style={{animationDelay: '0.1s'}}>
          <p className="text-xs font-bold text-sky-400 mb-2 pl-3 flex items-center">
            <span className="w-2 h-2 bg-sky-400 rounded-full mr-2"></span>
            æ—…è¡ŒãŒæ±ºã¾ã£ãŸã‚‰ï¼
          </p>
          <button 
            onClick={startDiagnosis}
            className="w-full group relative overflow-hidden bg-gradient-to-br from-sky-400 to-sky-600 text-white p-6 rounded-3xl shadow-xl shadow-sky-200 hover:shadow-2xl hover:scale-[1.02] transition-all active:scale-95"
          >
            <div className="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl group-hover:scale-150 transition-transform"></div>
            <div className="flex items-center justify-between relative z-10">
              <div className="flex items-center space-x-4">
                <div className="bg-white/20 p-3 rounded-2xl backdrop-blur-sm">
                  <Play size={28} fill="currentColor" />
                </div>
                <div className="text-left">
                  <div className="font-bold text-lg leading-tight">è·ç‰©ãƒã‚§ãƒƒã‚¯<br/>ãƒªã‚¹ãƒˆä½œæˆ</div>
                  <div className="text-xs opacity-90 mt-1 font-medium">è³ªå•ã«ç­”ãˆã¦ãƒªã‚¹ãƒˆã‚’ä½œã‚‹</div>
                </div>
              </div>
              <ChevronRight className="opacity-70" />
            </div>
          </button>
        </div>

        {/* ACTION 2: æº–å‚™ãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º (ã‚»ãƒƒãƒˆç®¡ç†) */}
        <div className="text-left animate-fade-in" style={{animationDelay: '0.2s'}}>
          <p className="text-xs font-bold text-indigo-400 mb-2 pl-3 flex items-center">
             <span className="w-2 h-2 bg-indigo-400 rounded-full mr-2"></span>
             ã‚‚ã£ã¨ä¾¿åˆ©ã«ï¼
          </p>
          <div className="bg-white border-2 border-indigo-50 rounded-3xl shadow-sm overflow-hidden">
             {/* AI Wizard Button */}
             <button 
              onClick={() => {
                setWizardStep('input');
                setWizardSituation('');
                setWizardSuggestions([]);
                setView('wizard');
              }}
              className="w-full flex items-center justify-between p-5 hover:bg-indigo-50/50 transition-colors active:bg-indigo-50 border-b border-indigo-50"
            >
              <div className="flex items-center space-x-4">
                <div className="bg-indigo-100 p-2.5 rounded-xl text-indigo-500">
                   <Sparkles size={22} fill="currentColor" className="opacity-80" />
                </div>
                <div className="text-left">
                  <div className="font-bold text-gray-700 text-base">AIã¨ãƒã‚¤ã‚»ãƒƒãƒˆã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</div>
                  <div className="text-xs text-gray-400">ã€Œæ¸©æ³‰æ—…è¡Œã€ãªã©ã®ã‚»ãƒƒãƒˆã‚’è‡ªå‹•ä½œæˆ</div>
                </div>
              </div>
              <ChevronRight className="text-gray-300" size={18} />
            </button>

             {/* Manual Manage Button */}
             <button 
              onClick={() => setView('manage')}
              className="w-full flex items-center justify-between p-4 hover:bg-gray-50 transition-colors active:bg-gray-100"
            >
              <div className="flex items-center space-x-4 pl-1">
                <div className="p-2 rounded-xl text-gray-400">
                   <Settings size={20} />
                </div>
                <div className="text-left">
                  <div className="font-bold text-gray-600 text-sm">æ‰‹å‹•ã§ã‚»ãƒƒãƒˆã‚’ç¢ºèªãƒ»ç·¨é›†</div>
                </div>
              </div>
              <ChevronRight className="text-gray-300" size={16} />
            </button>
          </div>
        </div>

        {/* Resume List (Conditional) */}
        {currentList.length > 0 && (
          <div className="animate-fade-in pt-4" style={{animationDelay: '0.3s'}}>
              <button 
                onClick={() => setView('checklist')}
                className="w-full flex items-center justify-between p-4 bg-emerald-50/80 border border-emerald-100 text-emerald-700 rounded-2xl shadow-sm hover:bg-emerald-100 transition-all active:scale-95"
              >
                <div className="flex items-center space-x-3">
                  <List size={20} className="text-emerald-500" />
                  <span className="font-bold text-sm">ä½œæˆä¸­ã®ãƒªã‚¹ãƒˆã®ç¶šãã‚’è¦‹ã‚‹</span>
                </div>
                <span className="text-xs bg-white px-2 py-1 rounded-full font-mono text-emerald-600">
                  {currentList.filter(i => i.checked).length}/{currentList.length}
                </span>
              </button>
          </div>
        )}

        {/* How To Link */}
        <div className="pt-6 animate-fade-in" style={{animationDelay: '0.4s'}}>
          <button 
            onClick={() => setView('howto')}
            className="text-sm text-gray-400 hover:text-sky-500 flex items-center justify-center transition-colors mx-auto py-2 px-4 rounded-full hover:bg-sky-50"
          >
            <HelpCircle size={16} className="mr-1.5" />
            ä½¿ã„æ–¹ã‚’è¦‹ã‚‹
          </button>
        </div>

      </div>
    </div>
  );

  const renderManageSets = () => {
    if (editingSet) {
      return (
        <div className="max-w-md mx-auto animate-fade-in pb-10 px-2">
          <div className="bg-white rounded-[2rem] shadow-xl overflow-hidden border border-gray-100">
            <div className="bg-slate-700 px-6 py-5 flex justify-between items-center text-white">
              <h3 className="font-bold text-lg">ã‚»ãƒƒãƒˆã®ç·¨é›†</h3>
              <button onClick={() => setEditingSet(null)} className="p-2 hover:bg-white/10 rounded-full transition-colors"><X size={24}/></button>
            </div>
            <div className="p-6 space-y-5">
              <div>
                <label className="block text-xs font-bold text-gray-400 uppercase mb-2 pl-1">ã‚»ãƒƒãƒˆå</label>
                <input 
                  type="text" 
                  value={editingSet.name}
                  onChange={(e) => setEditingSet({...editingSet, name: e.target.value})}
                  className="w-full border-2 border-gray-100 rounded-xl px-4 py-3 focus:border-slate-500 outline-none bg-gray-50 focus:bg-white transition-colors"
                />
              </div>
              <div>
                <label className="block text-xs font-bold text-gray-400 uppercase mb-2 pl-1">è³ªå•æ–‡</label>
                <input 
                  type="text" 
                  value={editingSet.question}
                  onChange={(e) => setEditingSet({...editingSet, question: e.target.value})}
                  className="w-full border-2 border-gray-100 rounded-xl px-4 py-3 focus:border-slate-500 outline-none bg-gray-50 focus:bg-white transition-colors text-sm"
                />
              </div>
              
              <div>
                <label className="block text-xs font-bold text-gray-400 uppercase mb-2 pl-1">æŒã¡ç‰©ãƒªã‚¹ãƒˆ</label>
                <div className="flex space-x-2 mb-3">
                  <input 
                    type="text" 
                    value={newItemText}
                    onChange={(e) => setNewItemText(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && addNewItemToEditingSet()}
                    className="flex-1 bg-white border-2 border-gray-100 rounded-xl px-4 py-2 text-sm outline-none focus:border-slate-500"
                    placeholder="è¿½åŠ ..."
                  />
                  <button onClick={addNewItemToEditingSet} className="bg-slate-700 text-white p-3 rounded-xl active:scale-95 transition-transform">
                    <Plus size={20} />
                  </button>
                </div>
                <div className="max-h-60 overflow-y-auto space-y-2 pr-1">
                  {editingSet.items.map((item, idx) => (
                    <div key={idx} className="flex justify-between items-center bg-gray-50 px-4 py-3 rounded-xl border border-gray-100 text-sm group hover:border-slate-200 transition-colors">
                      <span>{item}</span>
                      <button onClick={() => removeItemFromEditingSet(idx)} className="text-gray-300 hover:text-red-500 p-1 transition-colors">
                        <X size={16} />
                      </button>
                    </div>
                  ))}
                </div>
              </div>

              <div className="pt-4">
                <button 
                  onClick={() => saveSet(editingSet)}
                  className="w-full bg-slate-700 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-slate-800 active:scale-95 transition-all flex items-center justify-center space-x-2"
                >
                  <Save size={18} />
                  <span>å¤‰æ›´ã‚’ä¿å­˜</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    return (
      <div className="max-w-md mx-auto space-y-6 animate-fade-in pb-24 px-2">
        <div className="flex justify-between items-center px-2 pt-2">
          <h2 className="text-2xl font-bold text-gray-700">ãƒã‚¤ãƒ»ã‚»ãƒƒãƒˆ</h2>
          <button onClick={() => setView('home')} className="px-4 py-2 bg-white rounded-full text-sm font-bold text-gray-500 shadow-sm border border-gray-100 hover:text-sky-500 transition-colors">æˆ»ã‚‹</button>
        </div>

        <div className="space-y-4">
          {packingSets.map(set => (
            <div key={set.id} className="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 relative group transition-transform">
              <div className="flex justify-between items-start mb-3">
                <div className="flex items-center space-x-4">
                  <div className="bg-sky-50 p-3 rounded-2xl text-sky-500">
                    <Briefcase size={22} />
                  </div>
                  <h3 className="font-bold text-lg text-gray-700">{set.name}</h3>
                </div>
                <div className="flex space-x-2">
                  <button 
                    onClick={() => setEditingSet(set)}
                    className="p-3 bg-gray-50 text-gray-400 hover:text-sky-500 hover:bg-sky-50 rounded-xl transition-all"
                  >
                    <Edit3 size={18} />
                  </button>
                  <button 
                    onClick={() => deleteSet(set.id)}
                    className="p-3 bg-gray-50 text-gray-400 hover:text-rose-500 hover:bg-rose-50 rounded-xl transition-all"
                  >
                    <Trash2 size={18} />
                  </button>
                </div>
              </div>
              <p className="text-xs text-gray-500 mb-4 bg-gray-50 px-3 py-2 rounded-lg leading-relaxed">Q: {set.question}</p>
              <div className="flex flex-wrap gap-2">
                {set.items.slice(0, 4).map((item, i) => (
                  <span key={i} className="text-xs bg-white border border-gray-100 text-gray-500 px-3 py-1.5 rounded-lg">{item}</span>
                ))}
                {set.items.length > 4 && <span className="text-xs text-gray-400 px-2 py-1">+{set.items.length - 4}</span>}
              </div>
            </div>
          ))}
        </div>

        {/* Floating AI Wizard Button */}
        <button 
          onClick={() => {
            setWizardStep('input');
            setWizardSituation('');
            setWizardSuggestions([]);
            setView('wizard');
          }}
          className="fixed bottom-8 right-6 w-16 h-16 bg-indigo-500 text-white rounded-full shadow-xl shadow-indigo-200 flex items-center justify-center hover:bg-indigo-600 active:scale-90 transition-transform z-20 group"
          title="AIã¨æ–°ã—ã„ã‚»ãƒƒãƒˆã‚’ä½œã‚‹"
        >
          <Sparkles size={28} className="group-hover:rotate-12 transition-transform" />
        </button>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-[#FDFCF8] text-gray-800 font-sans p-4 md:p-8 pb-safe overflow-x-hidden">
      {view === 'home' && renderHome()}
      {view === 'diagnose' && renderDiagnosis()}
      {view === 'checklist' && renderChecklist()}
      {view === 'manage' && renderManageSets()}
      {view === 'wizard' && renderWizard()}
      {view === 'howto' && renderHowTo()}
      {renderModal()}

      <style>{`
        @keyframes fade-in {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        @keyframes bounce-slow {
          0%, 100% { transform: translateY(-5%); }
          50% { transform: translateY(5%); }
        }
        .animate-fade-in {
          animation: fade-in 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        .animate-bounce-slow {
          animation: bounce-slow 3s infinite ease-in-out;
        }
        .pb-safe {
          padding-bottom: env(safe-area-inset-bottom);
        }
        .select-none {
          user-select: none;
          -webkit-user-select: none;
        }
      `}</style>
    </div>
  );
}
