<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Icon Maker</title>
    
    <!-- 重要: 転送モードなら、余計なものを読み込まず即座に飛ばす -->
    <script>
        (function() {
            var params = new URLSearchParams(window.location.search);
            var url = params.get('url');
            if (url) {
                // httpがない場合の補完
                if (!url.startsWith('http')) url = 'https://' + url;
                
                // 履歴に残さない replace を使用
                window.location.replace(url);
                
                // 以降の処理を止めるためのフラグ
                window.isRedirecting = true;
            }
        })();
    </script>

    <!-- 以下のライブラリは、編集画面のときだけ読み込む（高速化） -->
    <script>
        if (!window.isRedirecting) {
            document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
            document.write('<script src="https://unpkg.com/lucide@latest"><\/script>');
        }
    </script>

    <style>
        /* iOSのようなスムーズな操作感 */
        body {
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        /* 転送中に表示するシンプルなスタイル（ライブラリ依存なし） */
        .redirect-msg {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            color: #666;
            background-color: #fff;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .ios-btn { cursor: pointer; transition: opacity 0.2s; }
        .ios-btn:active { opacity: 0.7; }
        
        /* 確実に隠す */
        .hidden { display: none !important; }
    </style>
    <!-- アイコン用プレースホルダー -->
    <link rel="apple-touch-icon" href="">
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">

    <!-- === 純粋なHTML/JSだけの転送画面 (ライブラリ読み込み待ちすらしない) === -->
    <div id="redirect-overlay" style="display: none;" class="redirect-msg">
        <div class="spinner"></div>
        <p>転送中...</p>
    </div>

    <script>
        // 転送モードなら、即座に簡易画面を表示して終了
        if (window.isRedirecting) {
            document.getElementById('redirect-overlay').style.display = 'flex';
            // bodyの中身をこれ以外レンダリングさせない
            document.body.style.backgroundColor = '#fff';
            throw new Error("Redirecting..."); // 以降のスクリプト実行を強制停止
        }
    </script>

    <!-- === ここから下は編集ツール用の画面（転送時は無視される） === -->

    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col relative overflow-hidden bg-gray-50">
        
        <!-- エディター画面 -->
        <div id="editor-screen" class="p-6 flex flex-col gap-6 animate-fade-in">
            <header class="flex items-center gap-2 py-2">
                <div class="bg-gradient-to-tr from-blue-500 to-indigo-600 p-2 rounded-lg text-white shadow-md">
                    <i data-lucide="layout-grid"></i>
                </div>
                <h1 class="font-bold text-xl text-gray-900">Icon Maker</h1>
            </header>

            <!-- プレビュー -->
            <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-200 flex flex-col items-center">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Preview</p>
                <div class="flex flex-col items-center gap-2">
                    <div class="w-[60px] h-[60px] rounded-[14px] bg-gray-100 shadow-md overflow-hidden relative border border-black/5 flex items-center justify-center">
                        <img id="preview-img" src="" class="w-full h-full object-cover hidden" alt="Icon">
                        <i id="preview-placeholder" data-lucide="image" class="text-gray-300 w-8 h-8"></i>
                    </div>
                    <span id="preview-title" class="text-[11px] font-medium text-gray-600 w-20 text-center truncate">アプリ名</span>
                </div>
            </div>

            <!-- 入力フォーム -->
            <div class="space-y-4">
                <div class="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm">
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i data-lucide="image" class="text-blue-500 w-4 h-4"></i> アイコン画像
                    </label>
                    <input type="file" id="image-input" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                </div>

                <div class="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm">
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i data-lucide="link" class="text-blue-500 w-4 h-4"></i> 飛び先のURL
                    </label>
                    <input type="text" id="url-input" placeholder="例: https://youtube.com" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-gray-800 focus:outline-none focus:bg-white transition-colors">
                </div>

                <div class="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm">
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i data-lucide="smartphone" class="text-blue-500 w-4 h-4"></i> アプリ名
                    </label>
                    <input type="text" id="title-input" placeholder="ホーム画面での名前" maxlength="12" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-gray-800 focus:outline-none focus:bg-white transition-colors">
                </div>
            </div>

            <button id="create-btn" class="ios-btn w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 px-6 rounded-2xl shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2 text-lg mt-2 relative z-10">
                アイコン作成準備
                <i data-lucide="arrow-down" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- 準備完了画面 -->
        <div id="ready-screen" style="display: none;" class="absolute inset-0 bg-slate-900 text-white flex-col z-20">
            <div class="absolute top-0 left-0 w-full h-full opacity-20 pointer-events-none overflow-hidden">
                <div class="absolute top-[-50px] left-[-50px] w-64 h-64 bg-purple-500 rounded-full blur-3xl"></div>
                <div class="absolute bottom-[-50px] right-[-50px] w-80 h-80 bg-blue-500 rounded-full blur-3xl"></div>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center p-6 z-10">
                <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-8 w-full max-w-sm text-center border border-white/20 shadow-2xl">
                    <div class="mb-6 flex justify-center">
                        <div class="relative">
                            <img id="ready-img" src="" class="w-24 h-24 rounded-2xl shadow-xl object-cover border-2 border-white/50">
                            <div class="absolute -bottom-2 -right-2 bg-green-500 text-white p-1 rounded-full border-2 border-slate-800">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </div>
                        </div>
                    </div>
                    
                    <h2 class="text-xl font-bold mb-4">準備完了！</h2>
                    <p class="text-sm text-gray-300 mb-6 leading-relaxed">
                        Safariの下のメニューにある<br>
                        <span class="inline-flex items-center mx-1 text-blue-300 font-bold"><i data-lucide="share" class="w-3 h-3 mr-1"></i>共有</span>から<br>
                        <span class="bg-slate-700 px-2 py-1 rounded text-white font-bold text-xs mx-1">ホーム画面に追加</span><br>
                        を選んでください。
                    </p>
                    
                    <button id="reset-btn" class="ios-btn text-sm text-gray-400 hover:text-white flex items-center justify-center w-full gap-2 py-2">
                        <i data-lucide="x" class="w-4 h-4"></i> 設定をやり直す
                    </button>
                </div>
            </div>

            <div class="pb-10 pt-4 flex flex-col items-center justify-end z-20 animate-bounce">
                <p class="text-sm font-bold mb-2 text-blue-300">ここをタップ！</p>
                <i data-lucide="arrow-down" class="w-8 h-8 text-blue-300"></i>
            </div>
        </div>

    </div>

    <script>
        // エディター用のスクリプト（転送時は実行しない）
        if (!window.isRedirecting) {
            
            // アイコン初期化
            try { lucide.createIcons(); } catch(e) {}

            // 要素取得
            const editorScreen = document.getElementById('editor-screen');
            const readyScreen = document.getElementById('ready-screen');
            const imageInput = document.getElementById('image-input');
            const urlInput = document.getElementById('url-input');
            const titleInput = document.getElementById('title-input');
            const previewImg = document.getElementById('preview-img');
            const previewPlaceholder = document.getElementById('preview-placeholder');
            const previewTitle = document.getElementById('preview-title');
            const readyImg = document.getElementById('ready-img');

            let imageData = null;
            let targetUrl = "";
            let appTitle = "";

            // 画像選択
            imageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        imageData = reader.result;
                        previewImg.src = imageData;
                        previewImg.classList.remove('hidden');
                        previewPlaceholder.classList.add('hidden');
                        readyImg.src = imageData;
                        updateFavicon(imageData);
                    };
                    reader.readAsDataURL(file);
                }
            });

            // タイトル入力
            titleInput.addEventListener('input', (e) => {
                appTitle = e.target.value;
                previewTitle.textContent = appTitle || 'アプリ名';
            });

            // 作成ボタン
            document.getElementById('create-btn').addEventListener('click', () => {
                targetUrl = urlInput.value;
                appTitle = titleInput.value;

                if (!targetUrl) { alert('URLを入力してください'); return; }
                if (!imageData) { alert('アイコン画像を選択してください'); return; }
                if (!targetUrl.startsWith('http')) targetUrl = 'https://' + targetUrl;

                // 画面切り替え
                editorScreen.style.display = 'none';
                readyScreen.style.display = 'flex';

                // URLパラメータ更新
                const newUrl = `${window.location.pathname}?url=${encodeURIComponent(targetUrl)}&title=${encodeURIComponent(appTitle)}`;
                window.history.replaceState(null, '', newUrl);
                document.title = appTitle;
                updateFavicon(imageData);
            });

            // リセット
            document.getElementById('reset-btn').addEventListener('click', () => {
                readyScreen.style.display = 'none';
                editorScreen.style.display = 'flex';
                window.history.replaceState(null, '', window.location.pathname);
                document.title = "Icon Maker";
            });

            function updateFavicon(dataUrl) {
                const links = document.querySelectorAll("link[rel*='icon']");
                links.forEach(link => link.remove());
                const link = document.createElement('link');
                link.type = 'image/png';
                link.rel = 'apple-touch-icon';
                link.href = dataUrl;
                document.getElementsByTagName('head')[0].appendChild(link);
            }
        }
    </script>
</body>
</html>
